---
title: "Analysis script for master thesis: Motivated Responses to a Masculinity Threat in a German Cultural Context"
output: html_document
date: "2025-08-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(here)
library(ggplot2)
library(stringr)
library(R.utils)
library(rlang)
library(tidyr)
library(jtools)
library(ggpubr)
library(lavaan)
library(corrplot)
library(psych)
library(car)
library(knitr)
library(kableExtra)
library(semTools)
library(boot)
library(mirt)
library(gridExtra)
```

load scripts
```{r}
source("word-catalog.R")
source("items-and-labels.R")
source("data-preprocessing.R")
source("visualization.R")
source("utils.R")
source("simulation.R")
source("inference-statistics.R")
source("factor-analysis.R")
```

# 1. Setup and Study Inclusion Criteria

## Load and Preprocess data
```{r}
df <- read.csv("../data/fragile_masculinity_motivation_anonymized.csv")
df <- preprocessData(df, all_items)
```
## Inclusion Criteria 

### 1. Debrief Consent
Participants that withdrew their consent after the debrief are excluded
```{r}
df <- exclude_participants(
  df,
  DEBRIEFCONSENT == "Y",
  vars = "DEBRIEFCONSENT",
  description = "Debrief consent"
)
```

### 2. Demographic criteria
Participants have to be older than 18 years, self-identify as male and native level German skills
```{r}
df <- exclude_participants(df, AGE >= 18, vars = "AGE", description = "Age")
df <- exclude_participants(df, SEX == "AO01", vars = "SEX", description = "Gender")
df <- exclude_participants(df, GER %in% c("AO04", "AO05"), vars = "GER", description = "German skills")
```
### 3. Suspicion
Participants may not indicate a strong suspicion about the study (coded in column SUSPICIONEXCLUSION, free text are excluded in anonymous data set)
```{r}
df <- exclude_participants(
  df,
  SUSPICIONEXCLUSION == FALSE,
  vars = "SUSPICIONEXCLUSION",
  description = "Suspicion"
)
```
### 4. WFCT comprehension
Participants should complete more than 50% of word fragments with existing words
```{r}
df <- exclude_participants(
  df,
  validWordCompletionScore >= 0.8,
  vars = "validWordCompletionScore",
  description = "WFCT comprehension"
)
```
### 5. WFCT Incomplete Responses
Participants that did not complete any of the word fragments for aggressive and anxious cognition
```{r}
df <- exclude_participants(
  df, !is.na(aggressiveWordCompletionScore),
  vars = "aggressiveWordCompletionScore",
  description = "Missing Aggressive Word Completion Score"
)

df <- exclude_participants(
  df, !is.na(anxiousWordCompletionScore),
  vars = "anxiousWordCompletionScore",
  description = "Missing Anxious Word Completion Score"
)
```

### 6. Responses to Motivation for Masculine Behaviour
```{r}
df <- exclude_participants(
  df,
  rowSums(!is.na(df[mmb_pressured_items])) >= 1,
  vars = mmb_pressured_items,
  description = "Missing all Pressured items"
)

df <- exclude_participants(
  df,
  rowSums(!is.na(df[mmb_autonomous_items])) >= 1,
  vars = mmb_autonomous_items,
  description = "Missing all Autonomous items"
)
```

# 2. Descriptive Analysis of Sample

## Conditions
```{r}
printNumberOfParticipants(df, "threatCondition")
```

## Age
```{r}
summary_mean_sd(df, "AGE")
```

## Educational Degree

```{r}
freq_table(df, EDU_label)
```

```{r}
plotBarHorizontal("EDU_label") +
  labs(
    x = NULL,
    y = "Anzahl"
  )
```

=> if participants indicated "AO01" => include analysis of no_edu

## Occupational Degree

```{r}
freq_table(df, OCC_label)
```

```{r}
plotBarHorizontal("OCC_label") +
  labs(
    x = NULL,
    y = "Anzahl"
  )
```

# 3. Manipulation Check

### Gender Knowledge Feedback
[GKFEEDBACK] Welche Rückmeldung haben Sie im Verlauf der Studie zu Ihrem Wissen in geschlechtsspezifischen Themen erhalten?
Scale 1 to 10
```{r}
summary_gkfeedback <- summary_mean_sd(df, "GKFEEDBACK", "threatCondition")
summary_gkfeedback
```

```{r}
plotHist("GKFEEDBACK", c(1, 10), "threatCondition")
```

Interpretation:
...

### Self evaluation of Gender Knowledge

[GKSELF] Wie würden Sie Ihr Wissen in geschlechtsspezifischen Themen einschätzen?
```{r}
summary_gkself <- summary_mean_sd(df, "GKSELF", "threatCondition")
summary_gkself
```

```{r}
plotHist("GKSELF", c(1, 10), "threatCondition")
```

Interpretation:
...

## Valid Word Completions

```{r}
summary_mean_sd(df, "validWordCompletionScore")
```

```{r}
plotBox("validWordCompletionScore")
```

Interpretation:
...

# Test Quality Criteria: Motivation for Masculine Behaviour
*Objectives:*
- Assess the *validity* and *reliability* of the scale Motivation for Masculine
Behaviour (MMB) 
- Compute participant latent trait scores

*Methodology*
- Visualization * Descriptives => Construct validity
- CFA and EFA to => construct validity
- McDonald's Omega => Reliabiltiy
- Regression scoring => latent trait scores

## Construct Validity 

### Visualization & Descriptives

```{r}
cor_mmb <- psych::polychoric(df[MMB_item_codes])$rho

corrplot(cor_mmb,
  method = "color",
  type = "upper",
  order = "original", 
  tl.col = "black",
  tl.srt = 45,
  diag = FALSE
)
```

```{r}
summary_mean_sd(df, MMB_item_codes)
```

Interpratation:
...

### Check sampling adequacy for Factory Analysis

```{r}
KMO(cor_mmb)
cortest.bartlett(cor_mmb, n = nrow(df))
```
KMO (Kaiser-Meyer-Olkin) should be > 0.6 (ideally > 0.8)
Bartlett’s test should be significant (p < .05)

Interpretation:
...


### Two-Factor Uncorrelated CFA
Testing the proposed 2 factor structure by Stanaland & Gaither (2021)

=> 2 factors
=> no covariance between factors
```{r}
model_twof <- "
  # latent variables
  Pressured =~ MMBi1 + MMBi2 + MMBi3 + MMBi4 + MMBi5
  Autonomous =~ MMBi6 + MMBi7 + MMBi8 + MMBi9

  # constrain covariance to 0
  Pressured ~~ 0*Autonomous
"

results_twof <- run_cfa_model(model_twof, df, model_name = "Two-Factor Uncorrelated", show_mi = FALSE)
```

Interpretation
...

### Exploratory Factor Analysis

#### Determine the number of latent factors

```{r}
fa.parallel(cor_mmb,
  fm = "ml",
  fa = "fa", n.iter = 100, show.legend = TRUE,
  main = "Parallel Analysis Scree Plot"
)
```
Interpretation
=> look for the elbow of the pot
=> Eigenvalues ?

=> EFA suggests a two factor model

#### Compute EFA

```{r}
efa_result_twof <- fa(df[MMB_item_codes], nfactors = 2, rotate = "oblimin", fm = "ml")
print(efa_result_twof, cut = 0.3) # only loadings > .30
```

Print loading table
```{r}
# Create loadings matrix
loadings_matrix <- as.data.frame(efa_result_twof$loadings[1:length(mmb_labels), ])

# Format table
loading_table <- data.frame(
  Item = MMB_item_codes,
  Label = mmb_labels,
  Factor1 = round(loadings_matrix$ML1, 2),
  Factor2 = round(loadings_matrix$ML2, 2)
)

# Hide loadings < .30
loading_table <- loading_table %>%
  mutate(
    Factor1 = ifelse(abs(Factor1) < 0.30, "", as.character(Factor1)),
    Factor2 = ifelse(abs(Factor2) < 0.30, "", as.character(Factor2))
  )

# Render nice APA-style table
loading_table %>%
  kbl(
    caption = "EFA Loadings for MMB Items (2-Factor Solution)",
    align = "lccc",
    booktabs = TRUE
  ) %>%
  kable_styling(
    full_width = FALSE,
    position = "center",
    bootstrap_options = c("striped", "hover", "condensed"),
    latex_options = "hold_position"
  ) %>%
  row_spec(0, bold = TRUE, background = "#f2f2f2") %>% # Light gray header
  row_spec(1:nrow(loading_table), background = "white", color = "black")
```

### Two-Factor Correlated CFA

2 latent factors, correlation allowed between factors
```{r}
model_twof_cor <- "
  # latent variables
  Pressured =~ MMBi1 + MMBi2 + MMBi3 + MMBi4 + MMBi5
  Autonomous =~ MMBi6 + MMBi7 + MMBi8 + MMBi9

  # allow correlation between factors
  Pressured ~~ Autonomous
"

results_twof_cor <- run_cfa_model(model_twof_cor, df, model_name = "Two-Factor Correlated", show_mi = TRUE)
```

Interpretation
...

Mod Indices suggest
A correlation between Item 5 and 9, This makes conceptually sense, because they
bith deal with anti femininity. 

#### Two-Factor Correlated + Residuals CFA

=> 2 latent factors
=> correlation allowed between factors
=> allow correlated residuals
```{r}
model_twof_cor_mod <- "
  # latent variables
  Pressured =~ MMBi1 + MMBi2 + MMBi3 + MMBi4 + MMBi5
  Autonomous =~ MMBi6 + MMBi7 + MMBi8 + MMBi9

  Pressured ~~ Autonomous

  # theory-based correlated residuals
  MMBi5 ~~ MMBi9
"

results_twof_cor_mod <- run_cfa_model(model_twof_cor_mod, df, model_name = "Two-Factor Correlated Modified", show_mi = TRUE)
```

Interpretation
...

## Reliability

``` {r}
fit_twof_cor_mod <- cfa(model_twof_cor_mod, data = df, std.lv = TRUE)
rel <- reliability(fit_twof_cor_mod)
print(rel)
```

Interpretation:
Omega values ≥ .70 (acceptable), ≥ .80 (good).
=> Alpha assumes tau-equivalence (all items same loading), which isn’t true here,
so we trust omega more

...

=> reliability is sufficient, so we use the proposed factor structure to 
compute factor scored for autonomous and pressured motivation 

## Latent Trait Scores

Use regression scoring from the chosen model, to compute latent trait scores
```{r}
fs_reg <- lavPredict(fit_twof_cor_mod, method = "regression")

df$regPressured <- scale(fs_reg[, "Pressured"])
df$regAutonomous <- scale(fs_reg[, "Autonomous"])
```

Row means
```{r}
df$rowmeansAutonomous <- rowMeans(
  df[mmb_autonomous_items],
  na.rm = TRUE
)

df$rowmeansPressured <- rowMeans(
  df[mmb_pressured_items],
  na.rm = TRUE
)
```

### Visualization & Descriptives
```{r}
summary_mean_sd(df, c("rowmeansAutonomous", "rowmeansPressured", "regAutonomous", "regPressured"))
```

```{r}
rm_aut_hist <- plotHist("rowmeansAutonomous", c(0, 7))
rm_pres_hist <- plotHist("rowmeansPressured", c(0, 7))
reg_aut_hist <- plotHist("regAutonomous", c(-5, 5))
reg_pres_hist <- plotHist("regPressured", c(-5, 5))

grid.arrange(rm_aut_hist, rm_pres_hist, reg_aut_hist, reg_pres_hist, ncol = 2)
```

-> regression scoring decreses reduces measurement error at the price of losing variance

```{r}
rm_box <- plotBox(c("rowmeansAutonomous", "rowmeansPressured"))
ggpar(rm_box, ylim = c(0,7))

reg_box <- plotBox(c("regAutonomous", "regPressured"))
ggpar(rm_box, ylim = c(-5, 5))


grid.arrange(ggpar(rm_box, ylim = c(0,7)), ggpar(reg_box, ylim = c(-5, 5)), ncol  = 2)
```

```{r}
cor(df$regAutonomous, df$regPressured)
cor(df$rowmeansAutonomous, df$rowmeansPressured)
```

Interpretation
...


# Test Quality Criteria: Aggressive Cognition
*Objectives:*
- Assess the *validity* and *reliability* of the scale for aggressive cognition
- Compute participant latent trait scores

*Methodology*
-

## Construct Validity

### Visualization & Descriptives

```{r}
summary_mean_sd(df, WFCT_aggression_items)
```

Interpretation:
- *Low Means:* 
- *Missing Values:* ...

```{r}
bad_items <- c("WFCTagg1", "WFCTagg2", "WFCTagg3","WFCTagg4", "WFCTagg5", "WFCTagg7", "WFCTagg9")
WFCT_aggr_clean <- df[ , setdiff(WFCT_aggression_items, bad_items)]
``` 

```{r}
cor_aggr <- psych::tetrachoric(WFCT_aggr_clean)$rho

corrplot::corrplot(cor_aggr,
  method = "color",
  type = "upper",
  order = "original",
  tl.col = "black",
  tl.srt = 45,
  diag = FALSE
)
```
-> a tetrachoric correlation is used, because responses are always binary 
(aggressive, vs. non-aggressive)

Interpretation:
...

#### Check sampling adequacy for Factor Analysis

```{r}
KMO(cor_aggr)
cortest.bartlett(cor_aggr, n = nrow(df))
```

KMO (Kaiser-Meyer-Olkin) should be > 0.6 (ideally > 0.8)
Bartlett’s test should be significant (p < .05)

Interpretation:
-  The KMO is extremely low, indicating that the items are not suited for a 
factor analysis
- This is because the items share very little variance ...


### One-Factor CFA

```{r}
model_aggr_onef <- "
  Aggression =~ WFCTagg1 + WFCTagg2 + WFCTagg3 + WFCTagg4 + WFCTagg5 + WFCTagg6 + WFCTagg7 + WFCTagg8 + WFCTagg9 + WFCTagg10
"

results_aggr_onef <- run_cfa_model(model_aggr_onef, df, model_name = "Aggression One-Factor", show_mi = FALSE)
```

Interpretation
...

### Exploratory Factory Analysis

#### Determine the number of latent factors

```{r}
fa.parallel(WFCT_aggr_clean,
  fm = "ml",
  fa = "fa", n.iter = 100, show.legend = TRUE,
  main = "Parallel Analysis Scree Plot"
)
```
Interpretation
=> look for the elbow of the pot
=> Eigenvalues 

=> EFA suggests ...

### Compute EFA

```{r}
efa_result_aggr_onef <- fa(cor_aggr, nfactors = 1)
```

## Reliability
```{r}
psych::alpha(WFCT_aggr_clean, check.keys = FALSE)
```

TOD
Interpretation:

## Latent Trait Scores

```{r}
df$aggressive_latent <- fscores(irt_aggr, method = "EAP") # expected a posteriori
df$aggressive_latent_z <- scale(df$aggressive_latent)
```

# Factor Structure Anxious Cognition

## Anxious Cognition

### Visualization

```{r}
cor_anx <- psych::polychoric(df[WFCT_anxiety_items])$rho

corrplot::corrplot(cor_anx,
  method = "color",
  type = "upper",
  order = "original",
  tl.col = "black",
  tl.srt = 45,
  diag = FALSE
)
```

```{r}
psych::describe(df[WFCT_anxiety_items])
```


# Hypothesis 1a & 1b

## Visualization

Aggressive and anxious word completions by threat condition
```{r}
plotBox(
  c("aggressiveWordCompletionScore", "anxiousWordCompletionScore"),
  "threatCondition"
)
```

## Hypothesis 1a t-test

### Assumption 1: Normality withing each group 

Check Visually
```{r}
check_normality_qq(
  df, aggressiveWordCompletionScoreTransformed,
  threatCondition
)
```
-> data points should be roughly on the line


```{r}
check_normality_hist(
  df, aggressiveWordCompletionScoreTransformed,
  threatCondition
)
```
-> should roughly resemble a normal distribution

### Assumption 2: Homogeneity of variance

Levene Test
```{r}
check_homogeneity(
  df, aggressiveWordCompletionScoreTransformed,
  threatCondition
)
```
p > .05 → equal variances (use Student’s t-test: var.equal = TRUE)


```{r}
summary_mean_sd(df, "aggressiveWordCompletionScore", group = "threatCondition")
```

```{r}
run_ttest(df, aggressiveWordCompletionScoreTransformed, threatCondition,
  alternative = "greater", var_equal = TRUE
)
```


## Hypothesis 1b t-test

### Assumption 1: Normality withing each group 

Check Visually
```{r}
check_normality_qq(df, anxiousWordCompletionScoreTransformed, threatCondition)
```
-> data points should be roughly on the line


```{r}
check_normality_hist(
  df, anxiousWordCompletionScoreTransformed,
  threatCondition
)
```
-> should roughly resemble a normal distribution

### Assumption 2: Homogeneity of variance

Levene Test
```{r}
check_homogeneity(df, anxiousWordCompletionScoreTransformed, threatCondition)
```
p > .05 → equal variances (use Student’s t-test: var.equal = TRUE)

```{r}
summary_mean_sd(df, "anxiousWordCompletionScore", group = "threatCondition")
```

Run inference statistic
```{r}
run_ttest(df, anxiousWordCompletionScoreTransformed, threatCondition,
  alternative = "greater", var_equal = TRUE
)
```

# Hypothesis 2a & 2b: Moderation of Threat Response 

## Visualization

2a: Moderation autonomous motivation for masculine behavior on aggressive word completions
```{r}
plotLine("regAutonomous", "anxiousWordCompletionScoreTransformed",
  condition = "threatCondition", df = df
)
```
2b: Moderation pressured motivation for masculine behavior on aggressive word completions
```{r}
plotLine("regPressured", "aggressiveWordCompletionScoreTransformed",
  condition = "threatCondition", df = df
)
```

## Hypothesis 2a 

### Multiple linear regression

Establish model
```{r}
model_anxious <- lm(anxiousWordCompletionScoreTransformed ~
  threatCondition * regAutonomous, data = df)
```

#### Assumption 1: Normality 

```{r}
plot(model_anxious, which = 2)
```

-> Q-Q plot points roughly on the line → residuals ~ normal.
-> identify possible outliers (highly influential points)


#### Assumption 2: Outliers

Examine outliers via residuals
```{r}
res <- residuals(model_anxious)

# Standardized residuals
res_std <- rstandard(model_anxious)

# Flag extreme residuals
outliers <- which(abs(res_std) > 2)
outliers
```

Examine outliers via cook's distance
```{r}
influential_obs <- df
influential_obs$cooksd <- cooks.distance(model_anxious)

n <- nrow(df)
k <- length(coef(model_anxious)) - 1
threshold <- 4 / (n - k - 1)


# influential_obs %>%
# filter(cooksd > threshold)
```
Cook’s distance > 4/(n-k-1) → potentially influential

#### Assumption 3: No Multikollinearity
```{r}
cor(df$regAutonomous, as.numeric(factor(df$threatCondition,
  levels = c("noThreat", "threat")
)) - 1)
```
-> would also make no sense, since I randomly assign threatCondition

Inference statistics
```{r}
summary(model_anxious)
```


# Post Hoc Analysis

...
