---
title: "Untitled"
author: "Linus Widmer"
date: "2025-07-21"
output: html_document
---

load library
```{r}
library(dplyr)
library(here)
library(ggplot2)
library(stringr)
```

load scripts
```{r}
source("word_catalog.R")
```


global variables for items
```{r}
MMB_pressured_items = c("MMBi1", "MMBi2", "MMBi3", "MMBi4", "MMBi5")
MMB_autonomous_items = c("MMBi6", "MMBi7", "MMBi8", "MMBi9")
WFCT_aggression_items = c("WFCTagg1", "WFCTagg2", "WFCTagg3", "WFCTagg4", "WFCTagg5", "WFCTagg6", "WFCTagg7", "WFCTagg8", "WFCTagg9", "WFCTagg10")
WFCT_anxiety_items = c("WFCTanx1", "WFCTanx2", "WFCTanx3", "WFCTanx4", "WFCTanx5", "WFCTanx6", "WFCTanx7", "WFCTanx8", "WFCTanx9", "WFCTanx10")
demographic_items = c("AGE", "EDU","EDUPUPIL", "OCCDEGREE", "SEX", "GER")
manipulation_items = c("threatCondition", "GKFEEDBACK", "OPENFEEDBACK", "GKSELF", "SUS", "SUSTEXT", "DEBRIEFCONSENT")
all_items = c("id", MMB_pressured_items, MMB_autonomous_items, WFCT_aggression_items, WFCT_anxiety_items, demographic_items, manipulation_items)
WFCT_all_items <- c(WFCT_aggression_items, WFCT_anxiety_items)
```

```{r}
edu_labels <- c(
  "AO01" = "Noch kein Abschluss/Schüler",
  "AO02" = "Schule beendet ohne Abschluss",
  "AO03" = "Haupt-/ Volksschule",
  "AO04" = "Mittlerer Schulabschluss / Realschule / mittlere Reife",
  "AO05" = "Fachhochschulreife / Fachoberschule",
  "AO06" = "Abitur, allgemeine oder fachgebundene Hochschulreife / (EOS)"
)

occ_labels <- c(
  "AO01" = "Noch keinen Berufsabschluss",
  "AO02" = "Lehre (beruflich-betrieblich)",
  "AO03" = "Ausbildung an Berufsfachschule, Handelsschule (beruflich- schulische Ausbildung)",
  "AO04" = "Fachschule (Meister-, Technikerschule, Berufs- oder Fachakademie)",
  "AO05" = "Fachhochschule / Ingenieurschule",
  "AO06" = "Universität / Hochschule",
  "AO07" = "Anderen Berufsabschluss (z.B. im Ausland erworben)"
)

```


## read data
```{r}
df = read.csv("results-survey371132.csv")
```

## sanitize data
```{r}
df = df %>% filter(lastpage == 31)
df = df %>% select(all_of(all_items))
count(df)$n
```

```{r}
df$EDU_label <- factor(
  str_wrap(edu_labels[df$EDU], width = 25),  # Wrap at 25 characters
  levels = str_wrap(edu_labels, width = 25)
)

df$OCC_label <- factor(
  str_wrap(occ_labels[df$OCC], width = 25),  # Wrap at 25 characters
  levels = str_wrap(occ_labels, width = 25)
)
```


## Exclusion Criteria 

1. Debrief consent = Y
2. Study inclusion Criteria 
 2.1 AGE >= 18
 2.2 SEX = M
 2.3 GER = Muttersprache
3. Manipulation Control
  3.1. GKFEEDBACK = depending on ThreatCondition
  3.2. OPENFEEDBACK auswerten
  3.3. SUS & SUSTEXT auswerten
4. WFCT comprehension check
  => More than 50% are real words...

### Debrief Consent
```{r}
df = df %>% 
  filter(DEBRIEFCONSENT == "Y")
count(df)$n
```

Study inclusion criteria
```{r}
df = df %>% 
  filter(AGE >= 18) %>% 
  filter(SEX == "AO01") 
  # %>% filter(GER == "AO05")
count(df)$n
```

Manipulation control
```{r}
# if threatCondition == "threat"
  # GKFEEDBACK == "AO02" | "GKFEEDBACK == "AO02"
# if threatCondition == "noThreat"
  # GKFEEDACK == "AO04"

table(df$GKFEEDBACK, df$threatCondition)
table(df$GKSELF)

```


WFCT comprehension check
```{r}

# Function to compute percentage of valid words
compute_score <- function(row) {
  total <- 0
  correct <- 0
  
  for (key in WFCT_all_items) {
    participant_word <- tolower(row[[key]])
    valid_words <- word_catalog[[key]]$word
    
    if (!is.na(participant_word) && participant_word %in% valid_words) {
      correct <- correct + 1
    }
    total <- total + 1
  }
  
  return(correct / total)
}

# Apply the function row-wise to df
df$validWordCompletionScore <- apply(df, 1, compute_score)
```

exclude participants with less than 50% valid word completions

```{r}
df = df %>% filter(validWordCompletionScore >= 0.5)
count(df)$n
table(df$validWordCompletionScore)
```

## Compute dependent variables

```{r}
# function to compute number of relative number aggressive/anxious responses to items 
compute_WFCT_score <- function(row, WFCT_items) {
  count <- 0
  total <- length(WFCT_items)
  
  for (key in WFCT_items) {
    participant_word <- tolower(row[[key]])
    
    if (!is.na(participant_word)) {
      word_df <- word_catalog[[key]]
      match_row <- word_df[word_df$word == participant_word, ]
      
      if (nrow(match_row) > 0 && match_row$encoding == "A") {
        count <- count + 1
      }
    }
  }
  
  return(count / total)
}
```


```{r}
df$aggressiveWordCompletionScore <- apply(df, 1, compute_WFCT_score, WFCT_items = WFCT_aggression_items)

table(df$aggressiveWordCompletionScore)
```


```{r}
df$anxiousWordCompletionScore <- apply(df, 1, compute_WFCT_score, WFCT_items = WFCT_anxiety_items)

table(df$anxiousWordCompletionScore)
```

## Descriptive Analysis

### Age
```{r}
mean(df$AGE)
sd(df$AGE)
```

## Educational Degree

```{r}
# table(df$EDU)
ggplot(df, aes(x = EDU_label)) +
  geom_bar(fill = "#4E79A7") +
  labs(
    title = "Was ist ihr höchster Schulabschluss?",
    x = NULL,
    y = "Anzahl"
  ) +
  theme_minimal() +
  coord_flip()

```


```{r}

ggplot(df, aes(x = OCC_label)) +
  geom_bar(fill = "#59A14F") +
  labs(
    title = "Welchen höchsten beruflichen Abschluss haben Sie?",
    x = NULL,
    y = "Anzahl"
  ) +
  theme_minimal() +
  coord_flip()

```


## Helper

```{r}
get_non_existing_words <- function(df, WFCT_items) {
  non_matches <- list()
  
  for (key in WFCT_items) {
    non_matches[[key]] <- character(0)  # initialize empty vector
    
    for (i in seq_len(nrow(df))) {
      word <- tolower(df[[key]][i])
      
      if (!is.na(word)) {
        valid_words <- tolower(word_catalog[[key]]$word)
        
        if (!(word %in% valid_words)) {
          non_matches[[key]] <- c(non_matches[[key]], word)
        }
      }
    }
  }
  
  return(non_matches)
}
get_non_existing_words(df, WFCT_all_items)
```


