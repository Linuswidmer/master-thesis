---
title: "Untitled"
output: html_document
date: "2025-08-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


load library
```{r message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(here)
library(ggplot2)
library(stringr)
library(R.utils)
library(rlang)
library(tidyr)
library(jtools)
library(ggpubr)
library(lavaan)
library(corrplot)
library(psych)
library(car)
```

load scripts
```{r}
source("word-catalog.R")
source("items-and-labels.R")
source("data-preprocessing.R")
source("visualization.R")
source("utils.R")
source("simulation.R")
source("inference-statistics.R")
```

## Load and Preprocess data
```{r}
df = read.csv("data/fragile_masculinity_motivation_anonymized.csv")
df = preprocessData(df, all_items)
# df = simulate_data()
```
## Inclusion Criteria 

### 1. Debrief Consent
Participants can withdraw their consent after the debrief
```{r}
df <- exclude_participants(df, DEBRIEFCONSENT == "Y", "Debrief consent")
```

### 2. Demographic criteria
Participants have to be older than 18 years, self-identify as male and native level German skills
```{r}
df <- exclude_participants(df, AGE >= 18, "Age")
df <- exclude_participants(df, SEX == "AO01", "Gender")
df <- exclude_participants(df, GER == "AO05" | GER == "AO04", "German skills")
```
### 3. Suspicion
Participants may not indicate a strong suspicion about the study (coded in column SUSPICIONEXCLUSION, free text are excluded in anonymous data set)
```{r}
df <- exclude_participants(df, SUSPICIONEXCLUSION == FALSE, "Suspicion")
```
### 4. WFCT comprehension
Participants should complete more than 50% of word fragments with existing words
```{r}
df <- exclude_participants(df, validWordCompletionScore >= 0.5, "WFCT comprehension")
```
### 5. Incomplete Responses

```{r}
df <- exclude_participants(df, !is.na(aggressiveWordCompletionScore), "Missing Aggressive Word Completion Score")
df <- exclude_participants(df, !is.na(anxiousWordCompletionScore), "Missing Anxious Word Completion Score")
```

# Factor Structure Motivation for Masculine Behaviour

## Confirmatory Factor Analysis
Testing the proposed 2 factor structure by Stanaland & Gaither (2021)

### Compute Model
```{r}
cfa_model <- '
  # latent variables
  Pressured =~ MMBi1 + MMBi2 + MMBi3 + MMBi4 + MMBi5
  Autonomous =~ MMBi6 + MMBi7 + MMBi8 + MMBi9
  
  # constrain covariance to 0
  Pressured ~~ 0*Autonomous
'

fit <- cfa(cfa_model, data = df, std.lv = TRUE)
```

```{r}
summary(fit, fit.measures = TRUE, standardized = TRUE)
```

### Evaluate model fit
```{r}
# Extract fit indices
fit_values <- fitMeasures(fit, c("cfi", "tli", "rmsea", "srmr"))

# Define common criteria
criteria <- c(cfi = 0.95, tli = 0.95, rmsea = 0.06, srmr = 0.08)

fit_summary <- data.frame(
  Index = names(fit_values),
  Value = round(fit_values, 3),
  Criteria = criteria
)

print(fit_summary)
```

## Exploratory Factor Analysis

### Visualize using corrplot

```{r}
mmb_items <- df %>%
  select(all_of(MMB_item_codes)) %>%
  select(where(is.numeric)) %>%
  na.omit()

# Compute correlation matrix
cor_matrix <- cor(mmb_items)

corrplot(cor_matrix, 
         method = "color",
         type = "upper",
         order = "original",  # preserves the column order
         tl.col = "black",
         tl.srt = 45,
         diag = FALSE)
```
### Check sampling adequacy for EFA 

```{r}
KMO(mmb_items)
cortest.bartlett(cor(mmb_items))
```
KMO (Kaiser-Meyer-Olkin) should be > 0.6 (ideally > 0.8)
Bartlett’s test should be significant (p < .05)


### EFA Determine the number of latent factors

```{r}
fa.parallel(mmb_items, fa = "fa", n.iter = 100, show.legend = TRUE, main = "Parallel Analysis Scree Plot")
```
=> look for the elbow of the pot
=> Eigenvalues ?

### Compute EFA
```{r}
efa_result <- fa(mmb_items, nfactors = 2, rotate = "oblimin", fm = "ml")
print(efa_result, cut = 0.3)   # only loadings > .30
```

Define latent factor structure
```{r}
MMB_pressured_items = c("MMBi1", "MMBi2", "MMBi3", "MMBi4", "MMBi5")
MMB_autonomous_items = c("MMBi6", "MMBi7", "MMBi8", "MMBi9")
```

### Compute Scores for MMB latent factors

```{r}
df$mmb_autonomous_score = rowMeans(
  df[MMB_autonomous_items],
  na.rm = TRUE
)

df$mmb_pressured_score = rowMeans(
  df[MMB_pressured_items],
  na.rm = TRUE
)
```

### Inclusion Critera 5

Has to have score of MMB Scales
```{r}
df <- exclude_participants(df, !is.na(mmb_autonomous_score), "Missing MMB Autonomous Score")
df <- exclude_participants(df, !is.na(mmb_pressured_score), "Missing MMB Pressured Score")
```


# Descriptive Analysis Final Sample

## Age
```{r}
summary_mean_sd(df, AGE)
```

## Educational Degree

```{r}
freq_table(df, EDU_label)
```


```{r}
plotBarHorizontal("EDU_label") + 
  labs(
    x = NULL,
    y = "Anzahl"
  ) 
```

## Occupational Degree

```{r}
freq_table(df, OCC_label)
```


```{r}
plotBarHorizontal("OCC_label") + 
  labs(
    x = NULL,
    y = "Anzahl"
  )
```


## Manipulation Check

### Gender Knowledge Feedback
[GKFEEDBACK] Welche Rückmeldung haben Sie im Verlauf der Studie zu Ihrem Wissen in geschlechtsspezifischen Themen erhalten?
Scale 1 to 10
```{r}
summary_gkfeedback <- summary_mean_sd(df, GKFEEDBACK, "threatCondition")
summary_gkfeedback
```


```{r}
plotHist("GKFEEDBACK", c(1, 10), "threatCondition") +
  geom_vline(
    data = summary_gkfeedback,
    aes(xintercept = mean, color = threatCondition),
    linetype = "dashed",
    linewidth = 1
  ) +
  labs(
    x = NULL,
    y = "Count",
    fill = "Condition",
    color = "Condition"
  )
```


### Self evaluation of Gender Knowledge
[GKSELF] Wie würden Sie Ihr Wissen in geschlechtsspezifischen Themen einschätzen?

```{r}
summary_gkself <- summary_mean_sd(df, GKSELF, "threatCondition")
summary_gkself
```

```{r}
plotHist("GKSELF", c(1, 10), "threatCondition") +
  geom_vline(
    data = summary_gkself,
    aes(xintercept = mean, color = threatCondition),
    linetype = "dashed",
    linewidth = 1
  ) +
  labs(
    x = NULL,
    y = "Count",
    fill = "Condition",
    color = "Condition"
  )
```


## Valid Word Completions

```{r}
summary_mean_sd(df, "validWordCompletionScore")
```

```{r}
plotBox("validWordCompletionScore")
```


## Motivation for Masculine Behaviour

```{r}
plotHist("mmb_autonomous_score", c(1,7))
plotHist("mmb_pressured_score", c(1,7))

p = plotBox(c("mmb_autonomous_score", "mmb_pressured_score"))
ggpar(p, ylim = c(1, 7))
```

Reliabilty MMB Scales
```{r}
omega(mmb_items[, MMB_pressured_items])
omega(mmb_items[, MMB_autonomous_items])
```


# Hypothesis 1a & 1b

## Visualization

Aggressive and anxious word completions by threat condition
```{r}
plotBox(c("aggressiveWordCompletionScore", "anxiousWordCompletionScore"), "threatCondition")
```

## Hypothesis 1a t-test

### Assumption 1: Normality withing each group 

Check Visually
```{r}
check_normality_qq(df, aggressiveWordCompletionScoreTransformed, threatCondition)
```
-> data points should be roughly on the line


```{r}
check_normality_hist(df, aggressiveWordCompletionScoreTransformed, threatCondition)
```
-> should roughly resemble a normal distribution

### Assumption 2: Homogeneity of variance

Levene Test
```{r}
check_homogeneity(df, aggressiveWordCompletionScoreTransformed, threatCondition)
```
p > .05 → equal variances (use Student’s t-test: var.equal = TRUE)


```{r}
summary_mean_sd(df, aggressiveWordCompletionScore, group = 'threatCondition')
```

```{r}
run_ttest(df, aggressiveWordCompletionScoreTransformed, threatCondition,
          alternative = "greater", var_equal = TRUE)
```


## Hypothesis 1b t-test

### Assumption 1: Normality withing each group 

Check Visually
```{r}
check_normality_qq(df, anxiousWordCompletionScoreTransformed, threatCondition)
```
-> data points should be roughly on the line


```{r}
check_normality_hist(df, anxiousWordCompletionScoreTransformed, threatCondition)
```
-> should roughly resemble a normal distribution

### Assumption 2: Homogeneity of variance

Levene Test
```{r}
check_homogeneity(df, anxiousWordCompletionScoreTransformed, threatCondition)
```
p > .05 → equal variances (use Student’s t-test: var.equal = TRUE)

```{r}
summary_mean_sd(df, anxiousWordCompletionScore, group = 'threatCondition')
```

Run inference statistic
```{r}
run_ttest(df, anxiousWordCompletionScoreTransformed, threatCondition,
          alternative = "greater", var_equal = TRUE)
```

# Hypothesis 2a & 2b: Moderation of Threat Response 

## Visualization

2a: Moderation autonomous motivation for masculine behavior on aggressive word completions
```{r}
plotLine("mmb_autonomous_score", "anxiousWordCompletionScoreTransformed", condition = "threatCondition", df = df)
```
2b: Moderation pressured motivation for masculine behavior on aggressive word completions
```{r}
plotLine("mmb_pressured_score", "aggressiveWordCompletionScoreTransformed", condition = "threatCondition", df = df)
```

## Hypothesis 2a 

### Multiple linear regression

Establish model
```{r}
model_anxious <- lm(anxiousWordCompletionScoreTransformed ~ threatCondition * mmb_autonomous_score, data = df)
```

#### Assumption 1: Normality 

```{r}
plot(model_anxious, which = 2)
```

-> Q-Q plot points roughly on the line → residuals ~ normal.
-> identify possible outliers (highly influential points)


#### Assumption 2: Outliers

Examine outliers via residuals
```{r}
res <- residuals(model_anxious)

# Standardized residuals
res_std <- rstandard(model_anxious)

# Flag extreme residuals
outliers <- which(abs(res_std) > 2)
outliers

```

Examine outliers via cook's distance
```{r}
influential_obs <- df
influential_obs$cooksd <- cooks.distance(model_anxious)

n <- nrow(df)
k <- length(coef(model_anxious)) - 1
threshold <- 4 / (n - k - 1)


influential_obs %>%
  filter(cooksd > threshold)
```
Cook’s distance > 4/(n-k-1) → potentially influential

#### Assumption 3: No Multikollinearity
```{r}
cor(df$mmb_autonomous_score, as.numeric(factor(df$threatCondition, levels = c("noThreat", "threat"))) - 1)
```
-> would also make no sense, since I randomly assign threatCondition



Inference statistics
```{r}
summary(model_anxious)
```



