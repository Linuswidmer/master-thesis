---
title: "Untitled"
output: html_document
date: "2025-08-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


load library
```{r message=FALSE, warning=FALSE}
library(dplyr)
library(here)
library(ggplot2)
library(stringr)
library(R.utils)
library(rlang)
library(tidyr)
library(jtools)
library(ggpubr)
library(lavaan)
library(corrplot)
```

load scripts
```{r}
source("word-catalog.R")
source("items-and-labels.R")
source("data-preprocessing.R")
source("visualization.R")
source("utils.R")
source("simulation.R")
```

## Load and Preprocess data
```{r}
df_raw = read.csv("data/fragile_masculinity_motivation_anonymized.csv")
df = preprocessData(df_raw, all_items)
# df = simulate_data()
```
## Inclusion Criteria 

### 1. Debrief Consent
Participants can withdraw their consent after the debrief
```{r}
df <- exclude_participants(df, DEBRIEFCONSENT == "Y", "Debrief consent")
```

### 2. Demographic criteria
Participants have to be older than 18 years, self-identify as male and native level German skills
```{r}
df <- exclude_participants(df, AGE >= 18, "Age")
df <- exclude_participants(df, SEX == "AO01", "Gender")
df <- exclude_participants(df, GER == "AO05" | GER == "AO04", "German skills")
```
### 3. Suspicion
Participants may not indicate a strong suspicion about the study (coded in column SUSPICIONEXCLUSION, free text are excluded in anonymous data set)
```{r}
df <- exclude_participants(df, SUSPICIONEXCLUSION == FALSE, "Suspicion")
```
### 4. WFCT comprehension
Participants should complete more than 50% of word fragments with existing words
```{r}
df <- exclude_participants(df, validWordCompletionScore >= 0.5, "WFCT comprehension")
```
## Descriptive Analysis

### Age
```{r}
df %>%
  summarise(
    mean_age = round(mean(AGE, na.rm = TRUE), 2),
    sd_age = round(sd(AGE, na.rm = TRUE), 2),
  )
```

### Manipulation Check

```{r}
## [GKFEEDBACK] Welche R체ckmeldung haben Sie im Verlauf der Studie zu Ihrem Wissen in geschlechtsspezifischen Themen erhalten?
## Scale 1 to 10

plotHist("GKFEEDBACK",c(1,10),  "threatCondition") +
  labs(
    # title = "Welche R체ckmeldung haben SIe erhalten?",
    x = NULL,
    y = "Anzahl",
    fill = "Bedingung"
  )

```

```{r}
## [GKSELF] Wie w체rden Sie Ihr Wissen in geschlechtsspezifischen Themen einsch채tzen?
plotHist("GKSELF", c(1,10)) + 
  labs(
    x = NULL,
    y = "Anzahl"
  ) 
```



### Educational and OCcupational Degree

```{r}
plotBarHorizontal("EDU_label") + 
  labs(
    x = NULL,
    y = "Anzahl"
  ) 

plotBarHorizontal("OCC_label") + 
  labs(
    x = NULL,
    y = "Anzahl"
  ) 
```


### Valid Word Completions

```{r}
df %>%
  summarise(
    mean_valid = round(mean(validWordCompletionScore, na.rm = TRUE), 2),
    sd_valid = round(sd(validWordCompletionScore, na.rm = TRUE), 2),
  )
```

```{r}
plotBox("validWordCompletionScore")
```

# Factor analysis: Motivation for Masculine Behaviour

## Visualize using corrplot
```{r}
# Select only the MMBi items
mmb_items <- df[, MMB_items]

# Compute correlation matrix
cor_matrix <- cor(mmb_items)

corrplot(cor_matrix, 
         method = "color",
         type = "upper",
         order = "original",  # preserves the column order
         tl.col = "black",
         tl.srt = 45,
         diag = FALSE)
```


## CFA for 2 latent factors, uncorrelated

Compute Model
```{r}
cfa_model <- '
  # latent variables
  Pressured =~ MMBi1 + MMBi2 + MMBi3 + MMBi4 + MMBi5
  Autonomous =~ MMBi6 + MMBi7 + MMBi8 + MMBi9
  
  # constrain covariance to 0
  Pressured ~~ 0*Autonomous
'

fit <- cfa(cfa_model, data = df, std.lv = TRUE)
```

```{r}
summary(fit, fit.measures = TRUE, standardized = TRUE)
```

Evaluate model fit
```{r}
# Extract fit indices
fit_values <- fitMeasures(fit, c("cfi", "tli", "rmsea", "srmr"))

# Define common criteria
criteria <- c(cfi = 0.95, tli = 0.95, rmsea = 0.06, srmr = 0.08)

fit_summary <- data.frame(
  Index = names(fit_values),
  Value = round(fit_values, 3),
  Criteria = criteria
)

print(fit_summary)
```

## Compute Scores for MMB latent factors

```{r}
df$mmb_autonomous_score = rowMeans(
  df[MMB_autonomous_items],
  na.rm = TRUE
)

df$mmb_pressured_score = rowMeans(
  df[MMB_pressured_items],
  na.rm = TRUE
)
```


```{r}
plotHist("mmb_autonomous_score", c(1,7))
plotHist("mmb_pressured_score", c(1,7))

p = plotBox(c("mmb_autonomous_score", "mmb_pressured_score"))
ggpar(p, ylim = c(1, 7))
```


# Hypothesis Testing

## Visualization Hypothesis 1a & 1b

Aggessive and axious word completions by threat condition
```{r}
plotBox(c("aggressiveWordCompletionScore", "anxiousWordCompletionScore"), "threatCondition")
```

```{r}
df %>%
  group_by(threatCondition) %>%
  summarise(
    mean_aggressive = round(mean(aggressiveWordCompletionScore, na.rm = TRUE), 2),
    sd_aggressive = round(sd(aggressiveWordCompletionScore, na.rm = TRUE), 2),
  )

df %>%
  group_by(threatCondition) %>%
  summarise(
    mean_anxious = round(mean(anxiousWordCompletionScore, na.rm = TRUE), 2),
    sd_anxious = round(sd(anxiousWordCompletionScore, na.rm = TRUE), 2)
  )
```

```{r}
df %>%
  summarise(
    mean_autonomous = round(mean(mmb_autonomous_score, na.rm = TRUE), 2),
    sd_autonomous = round(sd(mmb_autonomous_score, na.rm = TRUE), 2),
  )

df %>%
  summarise(
    mean_pressured = round(mean(mmb_pressured_score, na.rm = TRUE), 2),
    sd_pressured = round(sd(mmb_pressured_score, na.rm = TRUE), 2)
  )
```

## Visualization Hypothesis 2a & 2b

2a: Moderation autonomous motivation for masculine behavior on aggressive word completions
```{r}
plotLine("mmb_autonomous_score", "anxiousWordCompletionScoreTransformed", condition = "threatCondition", df = df)
```

2b: Moderation pressured motivation for masculine behavior on aggressive word completions
```{r}
plotLine("mmb_pressured_score", "aggressiveWordCompletionScoreTransformed", condition = "threatCondition", df = df)
```





